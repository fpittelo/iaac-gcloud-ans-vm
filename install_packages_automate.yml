---
- name: install packages common to all servers
  hosts: test01
  become: true

  tasks:

############## update all         ###########################

#   - name: apt-get update on all hosts
#     apt:
#       update_cache: yes

############## install GIT ##################################

    - name: install git
      apt:
        name: git

############## Add apt key gor Ansible#######################

    - name: Add an Apt signing key, will not download if present
      ansible.builtin.apt_key:
        id: 6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367
        url: https://keyserver.ubuntu.com/pks/lookup?fingerprint=on&op=index&search=0x6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367
        state: present

############## Install Ansible ##############################

    - name: Install Ansible
      apt:
        name: ansible
        state: present

############## install Open-JDK ##############################

    - name: Install open-jdk
      apt:
        name: openjdk-11-jdk
        state: present

############## install Jenkins #################################

    - name: copy jenkins key to automate
      ansible.builtin.copy:
        src: /usr/share/keyrings/jenkins-keyring.asc
        dest: /usr/share/keyrings/jenkins-keyring.asc
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: copy source list to automate
      ansible.builtin.copy:
        src: /etc/apt/sources.list.d/jenkins.list
        dest: /etc/apt/sources.list.d/jenkins.list
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: apt-get update on all hosts
      apt:
        update_cache: yes

    - name: Install jenkins
      apt:
        name: jenkins
        state: present

    - name: Enable service jenkins, and not touch the state
      ansible.builtin.service:
        name: jenkins
        enabled: yes

    - name: Start service jenkins, if not started
      ansible.builtin.service:
        name: jenkins
        state: started

############## Clean up tasks #################################

    - name: Remove useless packages from the cache
      apt:
        autoclean: yes

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes

